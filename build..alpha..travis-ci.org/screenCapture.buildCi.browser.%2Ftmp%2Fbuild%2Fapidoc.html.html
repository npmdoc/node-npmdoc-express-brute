<html><head></head><body><div class="apidocDiv">
<style>
/*csslint
*/
.apidocDiv {
    background: #fff;
    font-family: Arial, Helvetica, sans-serif;
}
.apidocDiv a[href] {
    color: #33f;
    font-weight: bold;
    text-decoration: none;
}
.apidocDiv a[href]:hover {
    text-decoration: underline;
}
.apidocCodeCommentSpan {
    background: #bbf;
    color: #000;
    display: block;
}
.apidocCodeKeywordSpan {
    color: #d00;
    font-weight: bold;
}
.apidocCodePre {
    background: #eef;
    border: 1px solid;
    color: #777;
    padding: 5px;
    white-space: pre-wrap;
}
.apidocFooterDiv {
    margin-top: 20px;
    text-align: center;
}
.apidocModuleLi {
    margin-top: 10px;
}
.apidocSectionDiv {
    border-top: 1px solid;
    margin-top: 20px;
}
.apidocSignatureSpan {
    color: #777;
    font-weight: bold;
}
</style>
<h1>api documentation for
    <a href="https://github.com/AdamPflug/express-brute#readme">express-brute (v1.0.1)</a>
</h1>
<h4>A brute-force protection middleware for express routes that rate limits incoming requests</h4>
<div class="apidocSectionDiv"><a href="#apidoc.tableOfContents" id="apidoc.tableOfContents"><h1>table of contents</h1></a><ol>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-brute">module express-brute</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.express-brute">
            function <span class="apidocSignatureSpan"></span>express-brute
            <span class="apidocSignatureSpan">(store, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.AbstractClientStore">
            function <span class="apidocSignatureSpan">express-brute.</span>AbstractClientStore
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.FailForbidden">
            function <span class="apidocSignatureSpan">express-brute.</span>FailForbidden
            <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.FailMark">
            function <span class="apidocSignatureSpan">express-brute.</span>FailMark
            <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.FailTooManyRequests">
            function <span class="apidocSignatureSpan">express-brute.</span>FailTooManyRequests
            <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.MemoryStore">
            function <span class="apidocSignatureSpan">express-brute.</span>MemoryStore
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute._getKey">
            function <span class="apidocSignatureSpan">express-brute.</span>_getKey
            <span class="apidocSignatureSpan">(arr)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index">
            function <span class="apidocSignatureSpan">express-brute.</span>index
            <span class="apidocSignatureSpan">(store, options)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">number <span class="apidocSignatureSpan">express-brute.</span>instanceCount</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">express-brute.</span>AbstractClientStore.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">express-brute.</span>MemoryStore.prototype</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">express-brute.</span>defaults</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">express-brute.</span>index.prototype</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-brute.AbstractClientStore">module express-brute.AbstractClientStore</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.AbstractClientStore.AbstractClientStore">
            function <span class="apidocSignatureSpan">express-brute.</span>AbstractClientStore
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-brute.AbstractClientStore.prototype">module express-brute.AbstractClientStore.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.AbstractClientStore.prototype.increment">
            function <span class="apidocSignatureSpan">express-brute.AbstractClientStore.prototype.</span>increment
            <span class="apidocSignatureSpan">(key, lifetime, callback)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-brute.MemoryStore">module express-brute.MemoryStore</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.MemoryStore.MemoryStore">
            function <span class="apidocSignatureSpan">express-brute.</span>MemoryStore
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">express-brute.MemoryStore.</span>defaults</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-brute.MemoryStore.prototype">module express-brute.MemoryStore.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.MemoryStore.prototype.get">
            function <span class="apidocSignatureSpan">express-brute.MemoryStore.prototype.</span>get
            <span class="apidocSignatureSpan">(key, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.MemoryStore.prototype.reset">
            function <span class="apidocSignatureSpan">express-brute.MemoryStore.prototype.</span>reset
            <span class="apidocSignatureSpan">(key, callback)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.MemoryStore.prototype.set">
            function <span class="apidocSignatureSpan">express-brute.MemoryStore.prototype.</span>set
            <span class="apidocSignatureSpan">(key, value, lifetime, callback)</span>
            </a>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-brute.defaults">module express-brute.defaults</a><ol>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">express-brute.defaults.</span>attachResetToRequest</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">boolean <span class="apidocSignatureSpan">express-brute.defaults.</span>refreshTimeoutOnRequest</span>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.defaults.failCallback">
            function <span class="apidocSignatureSpan">express-brute.defaults.</span>failCallback
            <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.defaults.handleStoreError">
            function <span class="apidocSignatureSpan">express-brute.defaults.</span>handleStoreError
            <span class="apidocSignatureSpan">(err)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">number <span class="apidocSignatureSpan">express-brute.defaults.</span>freeRetries</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">number <span class="apidocSignatureSpan">express-brute.defaults.</span>maxWait</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">number <span class="apidocSignatureSpan">express-brute.defaults.</span>minWait</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">number <span class="apidocSignatureSpan">express-brute.defaults.</span>proxyDepth</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-brute.index">module express-brute.index</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index.index">
            function <span class="apidocSignatureSpan">express-brute.</span>index
            <span class="apidocSignatureSpan">(store, options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index.FailForbidden">
            function <span class="apidocSignatureSpan">express-brute.index.</span>FailForbidden
            <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index.FailMark">
            function <span class="apidocSignatureSpan">express-brute.index.</span>FailMark
            <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index.FailTooManyRequests">
            function <span class="apidocSignatureSpan">express-brute.index.</span>FailTooManyRequests
            <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index.MemoryStore">
            function <span class="apidocSignatureSpan">express-brute.index.</span>MemoryStore
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index._getKey">
            function <span class="apidocSignatureSpan">express-brute.index.</span>_getKey
            <span class="apidocSignatureSpan">(arr)</span>
            </a>

        </li>

        <li>

            <span class="apidocSignatureSpan">number <span class="apidocSignatureSpan">express-brute.index.</span>instanceCount</span>

        </li>

        <li>

            <span class="apidocSignatureSpan">object <span class="apidocSignatureSpan">express-brute.index.</span>defaults</span>

        </li>

    </ol></li>

    <li class="apidocModuleLi"><a href="#apidoc.module.express-brute.index.prototype">module express-brute.index.prototype</a><ol>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index.prototype.getMiddleware">
            function <span class="apidocSignatureSpan">express-brute.index.prototype.</span>getMiddleware
            <span class="apidocSignatureSpan">(options)</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index.prototype.now">
            function <span class="apidocSignatureSpan">express-brute.index.prototype.</span>now
            <span class="apidocSignatureSpan">()</span>
            </a>

        </li>

        <li>

            <a class="apidocElementLiA" href="#apidoc.element.express-brute.index.prototype.reset">
            function <span class="apidocSignatureSpan">express-brute.index.prototype.</span>reset
            <span class="apidocSignatureSpan">(ip, key, callback)</span>
            </a>

        </li>

    </ol></li>

</ol></div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-brute" id="apidoc.module.express-brute">module express-brute</a></h1>


    <h2>
        <a href="#apidoc.element.express-brute.express-brute" id="apidoc.element.express-brute.express-brute">
        function <span class="apidocSignatureSpan"></span>express-brute
        <span class="apidocSignatureSpan">(store, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">express-brute = function (store, options) {
	var i;
	ExpressBrute.instanceCount++;
	this.name = "brute"+ExpressBrute.instanceCount;
	_.bindAll(this, 'reset', 'getMiddleware');

	// set options
	this.options = _.extend({}, ExpressBrute.defaults, options);
	if (this.options.minWait &lt; 1) {
		this.options.minWait = 1;
	}
	this.store = store;

	// build delays array
	this.delays = [this.options.minWait];
	while(this.delays[this.delays.length-1] &lt; this.options.maxWait) {
		var nextNum = this.delays[this.delays.length-1] + (this.delays.length &gt; 1 ? this.delays[this.delays.length-2] : 0);
		this.delays.push(nextNum);
	}
	this.delays[this.delays.length-1] = this.options.maxWait;

	// set default lifetime
	if (typeof this.options.lifetime == "undefined") {
		this.options.lifetime = (this.options.maxWait/1000)*(this.delays.length + this.options.freeRetries);
		this.options.lifetime = Math.ceil(this.options.lifetime);
	}

	// generate "prevent" middleware
	this.prevent = this.getMiddleware();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.AbstractClientStore" id="apidoc.element.express-brute.AbstractClientStore">
        function <span class="apidocSignatureSpan">express-brute.</span>AbstractClientStore
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">AbstractClientStore = function () {
	
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.FailForbidden" id="apidoc.element.express-brute.FailForbidden">
        function <span class="apidocSignatureSpan">express-brute.</span>FailForbidden
        <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">FailForbidden = function (req, res, next, nextValidRequestDate) {
	setRetryAfter(res, nextValidRequestDate);
	res.status(403);
	res.send({error: {text: "Too many requests in this time frame.", nextValidRequestDate: nextValidRequestDate}});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.FailMark" id="apidoc.element.express-brute.FailMark">
        function <span class="apidocSignatureSpan">express-brute.</span>FailMark
        <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">FailMark = function (req, res, next, nextValidRequestDate) {
	res.status(429);
	setRetryAfter(res, nextValidRequestDate);
	res.nextValidRequestDate = nextValidRequestDate;
	next();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.FailTooManyRequests" id="apidoc.element.express-brute.FailTooManyRequests">
        function <span class="apidocSignatureSpan">express-brute.</span>FailTooManyRequests
        <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">FailTooManyRequests = function (req, res, next, nextValidRequestDate) {
	setRetryAfter(res, nextValidRequestDate);
	res.status(429);
	res.send({error: {text: "Too many requests in this time frame.", nextValidRequestDate: nextValidRequestDate}});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.MemoryStore" id="apidoc.element.express-brute.MemoryStore">
        function <span class="apidocSignatureSpan">express-brute.</span>MemoryStore
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">MemoryStore = function (options) {
	this.data = {};
	_.bindAll(this, 'set', 'get', 'reset');
	this.options = _.extend({}, MemoryStore.defaults, options);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      $ npm install express-brute

A Simple Example
----------------
``` js
var ExpressBrute = require('express-brute');

var store = new ExpressBrute.<span class="apidocCodeKeywordSpan">MemoryStore</span>(); // stores state locally, don't use this
 in production
var bruteforce = new ExpressBrute(store);

app.post('/auth',
	bruteforce.prevent, // error 429 if we hit this route too often
	function (req, res, next) {
		res.send('Success!');
	}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute._getKey" id="apidoc.element.express-brute._getKey">
        function <span class="apidocSignatureSpan">express-brute.</span>_getKey
        <span class="apidocSignatureSpan">(arr)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_getKey = function (arr) {
	var key = '';
	_(arr).each(function (part) {
		if (part) {
			key += crypto.createHash('sha256').update(part).digest('base64');
		}
	});
	return crypto.createHash('sha256').update(key).digest('base64');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		return typeof options.failCallback === 'undefined' ? this.options.failCallback : options.failCallback;
	}, this);

	// create middleware
	return _.bind(function (req, res, next) {
		keyFunc(req, res, _.bind(function (key) {
			if(!options.ignoreIP) {
				key = ExpressBrute.<span class="apidocCodeKeywordSpan">_getKey</span>([req.ip, this.name, key]);
			} else {
				key = ExpressBrute._getKey([this.name, key]);
			}

			// attach a simpler "reset" function to req.brute.reset
			if (this.options.attachResetToRequest) {
				var reset = _.bind(function (callback) {
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.index" id="apidoc.element.express-brute.index">
        function <span class="apidocSignatureSpan">express-brute.</span>index
        <span class="apidocSignatureSpan">(store, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">index = function (store, options) {
	var i;
	ExpressBrute.instanceCount++;
	this.name = "brute"+ExpressBrute.instanceCount;
	_.bindAll(this, 'reset', 'getMiddleware');

	// set options
	this.options = _.extend({}, ExpressBrute.defaults, options);
	if (this.options.minWait &lt; 1) {
		this.options.minWait = 1;
	}
	this.store = store;

	// build delays array
	this.delays = [this.options.minWait];
	while(this.delays[this.delays.length-1] &lt; this.options.maxWait) {
		var nextNum = this.delays[this.delays.length-1] + (this.delays.length &gt; 1 ? this.delays[this.delays.length-2] : 0);
		this.delays.push(nextNum);
	}
	this.delays[this.delays.length-1] = this.options.maxWait;

	// set default lifetime
	if (typeof this.options.lifetime == "undefined") {
		this.options.lifetime = (this.options.maxWait/1000)*(this.delays.length + this.options.freeRetries);
		this.options.lifetime = Math.ceil(this.options.lifetime);
	}

	// generate "prevent" middleware
	this.prevent = this.getMiddleware();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>












</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-brute.AbstractClientStore" id="apidoc.module.express-brute.AbstractClientStore">module express-brute.AbstractClientStore</a></h1>


    <h2>
        <a href="#apidoc.element.express-brute.AbstractClientStore.AbstractClientStore" id="apidoc.element.express-brute.AbstractClientStore.AbstractClientStore">
        function <span class="apidocSignatureSpan">express-brute.</span>AbstractClientStore
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">AbstractClientStore = function () {
	
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-brute.AbstractClientStore.prototype" id="apidoc.module.express-brute.AbstractClientStore.prototype">module express-brute.AbstractClientStore.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.express-brute.AbstractClientStore.prototype.increment" id="apidoc.element.express-brute.AbstractClientStore.prototype.increment">
        function <span class="apidocSignatureSpan">express-brute.AbstractClientStore.prototype.</span>increment
        <span class="apidocSignatureSpan">(key, lifetime, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">increment = function (key, lifetime, callback) {
	var self = this;
	this.get(key, function (err, value) {
		if (err) {
			callback(err);
		} else {
			var count = value ? value.count+1 : 1;
			self.set(key, {count: count, lastRequest: new Date(), firstRequest: new Date()}, lifetime, function (err) {
				var prevValue = {
					count: value ? value.count : 0,
					lastRequest: value ? value.lastRequest : null,
					firstRequest: value ? value.firstRequest : null
				};
				typeof callback == 'function' &amp;&amp; callback(err, prevValue);
			});
		}
	});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-brute.MemoryStore" id="apidoc.module.express-brute.MemoryStore">module express-brute.MemoryStore</a></h1>


    <h2>
        <a href="#apidoc.element.express-brute.MemoryStore.MemoryStore" id="apidoc.element.express-brute.MemoryStore.MemoryStore">
        function <span class="apidocSignatureSpan">express-brute.</span>MemoryStore
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">MemoryStore = function (options) {
	this.data = {};
	_.bindAll(this, 'set', 'get', 'reset');
	this.options = _.extend({}, MemoryStore.defaults, options);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      $ npm install express-brute

A Simple Example
----------------
``` js
var ExpressBrute = require('express-brute');

var store = new ExpressBrute.<span class="apidocCodeKeywordSpan">MemoryStore</span>(); // stores state locally, don't use this
 in production
var bruteforce = new ExpressBrute(store);

app.post('/auth',
	bruteforce.prevent, // error 429 if we hit this route too often
	function (req, res, next) {
		res.send('Success!');
	}
...</pre></li>
    </ul>




</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-brute.MemoryStore.prototype" id="apidoc.module.express-brute.MemoryStore.prototype">module express-brute.MemoryStore.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.express-brute.MemoryStore.prototype.get" id="apidoc.element.express-brute.MemoryStore.prototype.get">
        function <span class="apidocSignatureSpan">express-brute.MemoryStore.prototype.</span>get
        <span class="apidocSignatureSpan">(key, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">get = function (key, callback) {
	key = this.options.prefix+key;
	var data = this.data[key] &amp;&amp; this.data[key].value;
	if (data) {
		data = JSON.parse(data);
		data.lastRequest = new Date(data.lastRequest);
		data.firstRequest = new Date(data.firstRequest);
	}
	typeof callback == 'function' &amp;&amp; callback(null, data);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
				req.brute = {
					reset: reset
				};
			}


			// filter request
			this.store.<span class="apidocCodeKeywordSpan">get</span>(key, _.bind(function (err, value) {
				if (err) {
					this.options.handleStoreError({
						req: req,
						res: res,
						next: next,
						message: "Cannot get request count",
						parent: err
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.MemoryStore.prototype.reset" id="apidoc.element.express-brute.MemoryStore.prototype.reset">
        function <span class="apidocSignatureSpan">express-brute.MemoryStore.prototype.</span>reset
        <span class="apidocSignatureSpan">(key, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">reset = function (key, callback) {
	key = this.options.prefix+key;
	
	if (this.data[key] &amp;&amp; this.data[key].timeout) {
		longTimeout.clearTimeout(this.data[key].timeout);
	}
	delete this.data[key];
	typeof callback == 'function' &amp;&amp; callback(null);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			} else {
				key = ExpressBrute._getKey([this.name, key]);
			}

			// attach a simpler "reset" function to req.brute.reset
			if (this.options.attachResetToRequest) {
				var reset = _.bind(function (callback) {
					this.store.<span class="apidocCodeKeywordSpan">reset</span>(key, function (err) {
						if (typeof callback == 'function') {
							process.nextTick(function () {
								callback(err);
							});
						}
					});
				}, this);
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.MemoryStore.prototype.set" id="apidoc.element.express-brute.MemoryStore.prototype.set">
        function <span class="apidocSignatureSpan">express-brute.MemoryStore.prototype.</span>set
        <span class="apidocSignatureSpan">(key, value, lifetime, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">set = function (key, value, lifetime, callback) {
	key = this.options.prefix+key;
	lifetime = lifetime || 0;
	value = JSON.stringify(value);

	if (!this.data[key]) {
		this.data[key] = {};
	} else if (this.data[key].timeout) {
		longTimeout.clearTimeout(this.data[key].timeout);
	}
	this.data[key].value = value;

	if (lifetime) {
		this.data[key].timeout = longTimeout.setTimeout(_.bind(function () {
			delete this.data[key];
		}, this), 1000*lifetime);
	}
	typeof callback == 'function' &amp;&amp; callback(null);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
						delay = 0;
						nextValidRequestTime = firstRequestTime = lastValidRequestTime = this.now();
						remainingLifetime = this.options.lifetime || 0;
					}
				}

				if (nextValidRequestTime &lt;= this.now() || count &lt;= this.options.freeRetries) {
					this.store.<span class="apidocCodeKeywordSpan">set</span>(key, {
						count: count+1,
						lastRequest: new Date(this.now()),
						firstRequest: new Date(firstRequestTime)
					}, remainingLifetime, _.bind(function (err) {
						if (err) {
							this.options.handleStoreError({
								req: req,
...</pre></li>
    </ul>


</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-brute.defaults" id="apidoc.module.express-brute.defaults">module express-brute.defaults</a></h1>






    <h2>
        <a href="#apidoc.element.express-brute.defaults.failCallback" id="apidoc.element.express-brute.defaults.failCallback">
        function <span class="apidocSignatureSpan">express-brute.defaults.</span>failCallback
        <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">failCallback = function (req, res, next, nextValidRequestDate) {
	setRetryAfter(res, nextValidRequestDate);
	res.status(429);
	res.send({error: {text: "Too many requests in this time frame.", nextValidRequestDate: nextValidRequestDate}});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.defaults.handleStoreError" id="apidoc.element.express-brute.defaults.handleStoreError">
        function <span class="apidocSignatureSpan">express-brute.defaults.</span>handleStoreError
        <span class="apidocSignatureSpan">(err)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">handleStoreError = function (err) {
		throw {
			message: err.message,
			parent: err.parent
		};
	}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
				};
			}


			// filter request
			this.store.get(key, _.bind(function (err, value) {
				if (err) {
					this.options.<span class="apidocCodeKeywordSpan">handleStoreError</span>({
						req: req,
						res: res,
						next: next,
						message: "Cannot get request count",
						parent: err
					});
					return;
...</pre></li>
    </ul>










</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-brute.index" id="apidoc.module.express-brute.index">module express-brute.index</a></h1>


    <h2>
        <a href="#apidoc.element.express-brute.index.index" id="apidoc.element.express-brute.index.index">
        function <span class="apidocSignatureSpan">express-brute.</span>index
        <span class="apidocSignatureSpan">(store, options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">index = function (store, options) {
	var i;
	ExpressBrute.instanceCount++;
	this.name = "brute"+ExpressBrute.instanceCount;
	_.bindAll(this, 'reset', 'getMiddleware');

	// set options
	this.options = _.extend({}, ExpressBrute.defaults, options);
	if (this.options.minWait &lt; 1) {
		this.options.minWait = 1;
	}
	this.store = store;

	// build delays array
	this.delays = [this.options.minWait];
	while(this.delays[this.delays.length-1] &lt; this.options.maxWait) {
		var nextNum = this.delays[this.delays.length-1] + (this.delays.length &gt; 1 ? this.delays[this.delays.length-2] : 0);
		this.delays.push(nextNum);
	}
	this.delays[this.delays.length-1] = this.options.maxWait;

	// set default lifetime
	if (typeof this.options.lifetime == "undefined") {
		this.options.lifetime = (this.options.maxWait/1000)*(this.delays.length + this.options.freeRetries);
		this.options.lifetime = Math.ceil(this.options.lifetime);
	}

	// generate "prevent" middleware
	this.prevent = this.getMiddleware();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.index.FailForbidden" id="apidoc.element.express-brute.index.FailForbidden">
        function <span class="apidocSignatureSpan">express-brute.index.</span>FailForbidden
        <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">FailForbidden = function (req, res, next, nextValidRequestDate) {
	setRetryAfter(res, nextValidRequestDate);
	res.status(403);
	res.send({error: {text: "Too many requests in this time frame.", nextValidRequestDate: nextValidRequestDate}});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.index.FailMark" id="apidoc.element.express-brute.index.FailMark">
        function <span class="apidocSignatureSpan">express-brute.index.</span>FailMark
        <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">FailMark = function (req, res, next, nextValidRequestDate) {
	res.status(429);
	setRetryAfter(res, nextValidRequestDate);
	res.nextValidRequestDate = nextValidRequestDate;
	next();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.index.FailTooManyRequests" id="apidoc.element.express-brute.index.FailTooManyRequests">
        function <span class="apidocSignatureSpan">express-brute.index.</span>FailTooManyRequests
        <span class="apidocSignatureSpan">(req, res, next, nextValidRequestDate)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">FailTooManyRequests = function (req, res, next, nextValidRequestDate) {
	setRetryAfter(res, nextValidRequestDate);
	res.status(429);
	res.send({error: {text: "Too many requests in this time frame.", nextValidRequestDate: nextValidRequestDate}});
}</pre></li>
    <li>example usage<pre class="apidocCodePre">n/a</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.index.MemoryStore" id="apidoc.element.express-brute.index.MemoryStore">
        function <span class="apidocSignatureSpan">express-brute.index.</span>MemoryStore
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">MemoryStore = function (options) {
	this.data = {};
	_.bindAll(this, 'set', 'get', 'reset');
	this.options = _.extend({}, MemoryStore.defaults, options);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
      $ npm install express-brute

A Simple Example
----------------
``` js
var ExpressBrute = require('express-brute');

var store = new ExpressBrute.<span class="apidocCodeKeywordSpan">MemoryStore</span>(); // stores state locally, don't use this
 in production
var bruteforce = new ExpressBrute(store);

app.post('/auth',
	bruteforce.prevent, // error 429 if we hit this route too often
	function (req, res, next) {
		res.send('Success!');
	}
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.index._getKey" id="apidoc.element.express-brute.index._getKey">
        function <span class="apidocSignatureSpan">express-brute.index.</span>_getKey
        <span class="apidocSignatureSpan">(arr)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">_getKey = function (arr) {
	var key = '';
	_(arr).each(function (part) {
		if (part) {
			key += crypto.createHash('sha256').update(part).digest('base64');
		}
	});
	return crypto.createHash('sha256').update(key).digest('base64');
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
		return typeof options.failCallback === 'undefined' ? this.options.failCallback : options.failCallback;
	}, this);

	// create middleware
	return _.bind(function (req, res, next) {
		keyFunc(req, res, _.bind(function (key) {
			if(!options.ignoreIP) {
				key = ExpressBrute.<span class="apidocCodeKeywordSpan">_getKey</span>([req.ip, this.name, key]);
			} else {
				key = ExpressBrute._getKey([this.name, key]);
			}

			// attach a simpler "reset" function to req.brute.reset
			if (this.options.attachResetToRequest) {
				var reset = _.bind(function (callback) {
...</pre></li>
    </ul>






</div>

<div class="apidocSectionDiv">
<h1><a href="#apidoc.module.express-brute.index.prototype" id="apidoc.module.express-brute.index.prototype">module express-brute.index.prototype</a></h1>


    <h2>
        <a href="#apidoc.element.express-brute.index.prototype.getMiddleware" id="apidoc.element.express-brute.index.prototype.getMiddleware">
        function <span class="apidocSignatureSpan">express-brute.index.prototype.</span>getMiddleware
        <span class="apidocSignatureSpan">(options)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">getMiddleware = function (options) {
	// standardize input
	options = _.extend({}, options);
	var keyFunc = options.key;
	if (typeof keyFunc !== 'function') {
		keyFunc = function (req, res, next) { next(options.key); };
	}
	var getFailCallback = _.bind(function () {
		return typeof options.failCallback === 'undefined' ? this.options.failCallback : options.failCallback;
	}, this);

	// create middleware
	return _.bind(function (req, res, next) {
		keyFunc(req, res, _.bind(function (key) {
			if(!options.ignoreIP) {
				key = ExpressBrute._getKey([req.ip, this.name, key]);
			} else {
				key = ExpressBrute._getKey([this.name, key]);
			}

			// attach a simpler "reset" function to req.brute.reset
			if (this.options.attachResetToRequest) {
				var reset = _.bind(function (callback) {
					this.store.reset(key, function (err) {
						if (typeof callback == 'function') {
							process.nextTick(function () {
								callback(err);
							});
						}
					});
				}, this);
				if (req.brute &amp;&amp; req.brute.reset) {
					// wrap existing reset if one exists
					var oldReset = req.brute.reset;
					var newReset = reset;
					reset = function (callback) {
						oldReset(function () {
							newReset(callback);
						});
					};
				}
				req.brute = {
					reset: reset
				};
			}


			// filter request
			this.store.get(key, _.bind(function (err, value) {
				if (err) {
					this.options.handleStoreError({
						req: req,
						res: res,
						next: next,
						message: "Cannot get request count",
						parent: err
					});
					return;
				}

				var count = 0,
					delay = 0,
					lastValidRequestTime = this.now(),
					firstRequestTime = lastValidRequestTime;
				if (value) {
					count = value.count;
					lastValidRequestTime = value.lastRequest.getTime();
					firstRequestTime = value.firstRequest.getTime();

					var delayIndex = value.count - this.options.freeRetries - 1;
					if (delayIndex &gt;= 0) {
						if (delayIndex &lt; this.delays.length) {
							delay = this.delays[delayIndex];
						} else {
							delay = this.options.maxWait;
						}
					}
				}
				var nextValidRequestTime = lastValidRequestTime+delay,
					remainingLifetime = this.options.lifetime || 0;

				if (!this.options.refreshTimeoutOnRequest &amp;&amp; remainingLifetime &gt; 0) {
					remainingLifetime = remainingLifetime - Math.floor((this.now() - firstRequestTime) / 1000);
					if (remainingLifetime &lt; 1) {
						// it should be expired alredy, treat this as a new request and reset everything
						count = 0;
						delay = 0;
						nextValidRequestTime = firstRequestTime = lastValidRequestTime = this.now();
						remainingLifetime = this.options.lifetime || 0;
					}
				}

				if (nextValidRequestTime &lt;= this.now() || count &lt;= this.options.freeRetries) {
					this.store.set(key, {
						count: count+1,
						lastRequest: new Date(this.now()),
						firstRequest: new Date(firstRequestTime)
					}, remainingLifetime, _.bind(function (err) {
						if (err) {
							this.options.handleStoreError({
								req: req,
								res: res,
								next: next,
								message: "Cannot increment request count",
								parent: err
							});
							return;
						}
						typeof next == 'function' &amp;&amp; next();
					},this));
				} else {
					var failCallback = getFailCallback();
					typeof failCallback === 'function' &amp;&amp; failCallback(req, res, next, new Date(nextValidRequestTime));
				}
			}, this));
		},this));
	}, this);
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
	// set default lifetime
	if (typeof this.options.lifetime == "undefined") {
		this.options.lifetime = (this.options.maxWait/1000)*(this.delays.length + this.options.freeRetries);
		this.options.lifetime = Math.ceil(this.options.lifetime);
	}

	// generate "prevent" middleware
	this.prevent = this.<span class="apidocCodeKeywordSpan">getMiddleware</span>();
};
ExpressBrute.prototype.getMiddleware = function (options) {
	// standardize input
	options = _.extend({}, options);
	var keyFunc = options.key;
	if (typeof keyFunc !== 'function') {
		keyFunc = function (req, res, next) { next(options.key); };
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.index.prototype.now" id="apidoc.element.express-brute.index.prototype.now">
        function <span class="apidocSignatureSpan">express-brute.index.prototype.</span>now
        <span class="apidocSignatureSpan">()</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">now = function () {
	return Date.now();
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
						parent: err
					});
					return;
				}

				var count = 0,
					delay = 0,
					lastValidRequestTime = this.<span class="apidocCodeKeywordSpan">now</span>(),
					firstRequestTime = lastValidRequestTime;
				if (value) {
					count = value.count;
					lastValidRequestTime = value.lastRequest.getTime();
					firstRequestTime = value.firstRequest.getTime();

					var delayIndex = value.count - this.options.freeRetries - 1;
...</pre></li>
    </ul>



    <h2>
        <a href="#apidoc.element.express-brute.index.prototype.reset" id="apidoc.element.express-brute.index.prototype.reset">
        function <span class="apidocSignatureSpan">express-brute.index.prototype.</span>reset
        <span class="apidocSignatureSpan">(ip, key, callback)</span>
        </a>
    </h2>
    <ul>
    <li>description and source-code<pre class="apidocCodePre">reset = function (ip, key, callback) {
	key = ExpressBrute._getKey([ip, this.name, key]);
	this.store.reset(key, _.bind(function (err) {
		if (err) {
			this.options.handleStoreError({
				message: "Cannot reset request count",
				parent: err,
				key: key,
				ip: ip
			});
		} else {
			if (typeof callback == 'function') {
				process.nextTick(_.bind(function () {
					callback.apply(this, arguments);
				}, this));
			}
		}
	},this));
}</pre></li>
    <li>example usage<pre class="apidocCodePre">...
			} else {
				key = ExpressBrute._getKey([this.name, key]);
			}

			// attach a simpler "reset" function to req.brute.reset
			if (this.options.attachResetToRequest) {
				var reset = _.bind(function (callback) {
					this.store.<span class="apidocCodeKeywordSpan">reset</span>(key, function (err) {
						if (typeof callback == 'function') {
							process.nextTick(function () {
								callback(err);
							});
						}
					});
				}, this);
...</pre></li>
    </ul>


</div>

<div class="apidocFooterDiv">
    [ this document was created with
    <a href="https://github.com/kaizhu256/node-utility2" target="_blank">utility2</a>
    ]
</div>
</div>
</body></html>